# 2.2 IPFS Upload via Pinata

## Mục tiêu
Upload encrypted data lên IPFS thông qua Pinata API, lấy CID.

## Pinata Setup

### 1. Get API Keys
- Đăng ký tại [pinata.cloud](https://pinata.cloud)
- Tạo API Key với quyền `pinFileToIPFS`

### 2. Environment Variables
```env
NEXT_PUBLIC_PINATA_JWT=<jwt_token>
# hoặc
PINATA_API_KEY=<api_key>
PINATA_API_SECRET=<api_secret>
```

## API Integration

### Upload Function
```typescript
async function uploadToIPFS(encryptedBlob: Blob): Promise<string> {
  const formData = new FormData();
  formData.append('file', encryptedBlob, 'encrypted-vault.bin');
  
  const res = await fetch('https://api.pinata.cloud/pinning/pinFileToIPFS', {
    method: 'POST',
    headers: { Authorization: `Bearer ${JWT}` },
    body: formData
  });
  
  const { IpfsHash } = await res.json();
  return IpfsHash; // CID
}
```

### Retrieve Function
```typescript
async function fetchFromIPFS(cid: string): Promise<Blob> {
  const res = await fetch(`https://gateway.pinata.cloud/ipfs/${cid}`);
  return res.blob();
}
```

## CID Storage
- CID (~46 chars) lưu on-chain trong Vault account
- Example: `QmXnnyufdzAWL5CqZ2RnSNgPbvCc1ALT73s6epPrRnZ1Xy`

## Error Handling
- Network timeout → retry 3 lần
- File too large → reject trước khi upload
- Invalid response → throw với message rõ ràng

## Acceptance Criteria
- [ ] Upload blob thành công, nhận CID
- [ ] Fetch bằng CID trả về đúng data
- [ ] API key không expose ở client (dùng API route nếu cần)
