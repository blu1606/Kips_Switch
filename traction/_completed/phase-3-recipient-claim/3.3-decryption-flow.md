# 3.3 Decryption Flow

## Mục tiêu
Implement flow: Wallet decrypt key → AES decrypt file → trigger download.

## Flow Diagram
```
[Click "Decrypt"]
       ↓
[Fetch encrypted file from IPFS]
       ↓
[Fetch encrypted_key from on-chain]
       ↓
[Wallet signs to derive/decrypt AES key]
       ↓
[AES decrypt the file]
       ↓
[Trigger browser download]
```

## Implementation Steps

### Step 1: Fetch Encrypted Data
```typescript
const vault = await program.account.vault.fetch(vaultPDA);
const encryptedFile = await fetchFromIPFS(vault.ipfsCid);
const encryptedKey = vault.encryptedKey;
```

### Step 2: Decrypt AES Key
**Option A: Signature-based (simpler)**
```typescript
// Recipient signs known message → hash = key
const signature = await wallet.signMessage(message);
const aesKey = sha256(signature);
```

**Option B: TweetNaCl box (more secure)**
```typescript
import nacl from 'tweetnacl';
const decryptedKey = nacl.box.open(
  encryptedKey,
  nonce,
  senderPublicKey,
  recipientSecretKey
);
```

### Step 3: Decrypt File
```typescript
const decryptedBlob = await decryptFile(encryptedFile, aesKey);
```

### Step 4: Trigger Download
```typescript
const url = URL.createObjectURL(decryptedBlob);
const a = document.createElement('a');
a.href = url;
a.download = 'legacy-file'; // hoặc original filename nếu lưu
a.click();
URL.revokeObjectURL(url);
```

## UI States
- **Loading:** "Fetching encrypted data..."
- **Signing:** "Please sign in your wallet..."
- **Decrypting:** "Decrypting file..."
- **Success:** "Download started!" + success icon
- **Error:** Clear error message + retry button

## Error Handling
- IPFS fetch fail → "Could not retrieve file, try again"
- Wrong key → "Decryption failed, invalid key"
- Wallet reject → "Signature required to decrypt"

## Acceptance Criteria
- [ ] Click decrypt → wallet prompts signature
- [ ] File downloads với nội dung đúng
- [ ] Loading states hiển thị mượt
- [ ] Error handling graceful
