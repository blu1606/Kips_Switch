# 3.2 Permission Check

## Mục tiêu
Verify recipient có quyền truy cập vault và vault đã release chưa.

## Logic Flow

```
1. Get connected wallet address
2. Query all Vault accounts with recipient = wallet
3. For each vault:
   - Check is_released flag
   - Calculate: now > last_check_in + time_interval
4. Return list of claimable vaults
```

## Query Methods

### Option A: Fetch All Vaults
```typescript
const vaults = await program.account.vault.all([
  {
    memcmp: {
      offset: 40, // offset của recipient field
      bytes: wallet.publicKey.toBase58()
    }
  }
]);
```

### Option B: Derive PDA (nếu biết owner)
```typescript
const [vaultPDA] = PublicKey.findProgramAddressSync(
  [Buffer.from("vault"), ownerPubkey.toBuffer()],
  programId
);
const vault = await program.account.vault.fetch(vaultPDA);
```

## Permission States

| State | `is_released` | Time Check | Action |
|-------|--------------|------------|--------|
| Active | `false` | `now < deadline` | Locked, wait |
| Pending | `false` | `now > deadline` | Can trigger release |
| Released | `true` | - | Can decrypt |

## Trigger Release (Optional)
Nếu vault chưa `is_released` nhưng đã quá hạn:
```typescript
await program.methods
  .triggerRelease()
  .accounts({ vault: vaultPDA })
  .rpc();
```

## Security Notes
- Chỉ fetch vault mà user là recipient
- Không expose vault data của người khác
- Client-side check + on-chain verification

## Acceptance Criteria
- [ ] Query trả về đúng vault cho recipient
- [ ] Phân biệt đúng Active vs Released
- [ ] Không crash nếu không có vault nào
