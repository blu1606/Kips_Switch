# 4.1 Cron Job (Deadline Checker)

## Mục tiêu
Setup background job để check expired vaults và trigger notifications.

## Implementation: Next.js API Route + Vercel Cron

### API Route: `/api/cron/check-status`

```typescript
// Pseudo logic
export async function GET(request: Request) {
  // 1. Verify cron secret (security)
  // 2. Fetch all vault accounts
  // 3. For each vault:
  //    - If expired && !is_released → send warning
  //    - If approaching deadline → send reminder
  // 4. Return summary
}
```

### Vercel Cron Config (`vercel.json`)
```json
{
  "crons": [{
    "path": "/api/cron/check-status",
    "schedule": "0 * * * *"
  }]
}
```
→ Chạy mỗi giờ

## Check Logic

### Vault States to Handle
| Condition | Action |
|-----------|--------|
| `now > deadline` && `!is_released` | Trigger release, notify recipient |
| `now > deadline - 7 days` | Send reminder to owner |
| `now > deadline - 3 days` | Send urgent reminder |
| `now > deadline - 24 hours` | Send final warning |

### Query All Vaults
```typescript
const vaults = await program.account.vault.all();
for (const vault of vaults) {
  const deadline = vault.account.lastCheckIn + vault.account.timeInterval;
  // check conditions...
}
```

## Security
- Verify `CRON_SECRET` header
- Rate limit để tránh abuse
- Log mọi action để debug

## Acceptance Criteria
- [ ] Cron chạy đúng schedule trên Vercel
- [ ] Detect được expired vaults
- [ ] Không crash nếu có nhiều vaults
