# 14.3 Integration Testing Strategy (API)

> **Status:** In Progress
> **Goal:** Verify internal API routes and 3rd party integrations without full E2E overhead.
> **Tool:** `node-mocks-http` + Vitest

## ðŸŽ¯ Reach Coverage

### API Routes
- **`src/app/api/ai/write-assist`:** Mock Gemini response. Verify prompt construction and error handling.
- **`src/app/api/relay/claim`:** Verify transaction construction and validation logic.
- **`src/app/api/cron`:** Verify authentication (Cron secret) and job triggering.
- **`src/app/api/actions/ping`:** Verify Blinks protocol compliance and vault lookup.

### Service Layer (NEW - DAS API Migration)
- **`src/services/vault.ts`:** Database CRUD operations against Supabase.

---

## ðŸ› ï¸ Vault Service Test Cases

### `findVaultsByOwner(owner: PublicKey)`
| Case | Input | Expected |
|------|-------|----------|
| Owner with vaults | Valid wallet with indexed vaults | Array of `{pubkey, isReleased}` |
| Owner with no vaults | Valid wallet, no records | Empty array `[]` |
| Supabase unavailable | No connection | Empty array `[]` (graceful fallback) |

### `indexVault(pubkey, owner, recipient)`
| Case | Input | Expected |
|------|-------|----------|
| New vault | Unique pubkey | `true`, row created |
| Duplicate pubkey | Existing pubkey | `true`, row updated (upsert) |
| Invalid data | Empty strings | Implementation-dependent |

### `updateVaultCheckIn(pubkey)`
| Case | Input | Expected |
|------|-------|----------|
| Existing vault | Valid pubkey | `true`, timestamp updated |
| Non-existent vault | Unknown pubkey | `true` (no error, 0 rows affected) |

### `markVaultReleased(pubkey)`
| Case | Input | Expected |
|------|-------|----------|
| Existing vault | Valid pubkey | `true`, `is_released = true` |
| Already released | Released vault | `true`, idempotent |

---

## ðŸ§ª Implementation

### Option 1: Vitest with Supabase Mock
```typescript
// __tests__/services/vault.test.ts
import { describe, it, expect, vi } from 'vitest';
import { findVaultsByOwner } from '@/services/vault';
import { PublicKey } from '@solana/web3.js';

// Mock getSupabaseAdmin
vi.mock('@/utils/supabase', () => ({
  getSupabaseAdmin: vi.fn(() => ({
    from: vi.fn(() => ({
      select: vi.fn(() => ({
        eq: vi.fn(() => Promise.resolve({ 
          data: [{ pubkey: 'abc123', is_released: false }],
          error: null 
        }))
      }))
    }))
  }))
}));

describe('findVaultsByOwner', () => {
  it('returns vaults for valid owner', async () => {
    const owner = new PublicKey('11111111111111111111111111111111');
    const result = await findVaultsByOwner(owner);
    expect(result).toHaveLength(1);
  });
});
```

### Option 2: Integration Test Script
```bash
# scripts/test-vault-service.ts
# Runs against real Supabase with test data
# Cleanup after tests
```

---

## âœ… Success Criteria

| Metric | Target |
|--------|--------|
| Service function coverage | 100% (4 functions) |
| Edge case coverage | All null/empty/error paths |
| CI integration | Tests run on PR |
