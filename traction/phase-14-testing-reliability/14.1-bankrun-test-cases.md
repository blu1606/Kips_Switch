# 14.1 Bankrun Smart Contract Test Cases

## üéØ Goal

Comprehensive test coverage for Deadman's Switch smart contract using Bankrun for fast, isolated unit testing.

**Target**: 30 test cases across all instructions  
**Current**: 17/30 implemented (57%)  
**Performance**: <3s execution time ‚ö°

---

## üìä Coverage Status

### P0 Security-Critical (3/5)
- [x] `triggerRelease` - Should fail before expiry
- [x] `claimSol` - Should fail before release
- [x] `ping` - Should fail for unauthorized user
- [~] `triggerRelease` - Should succeed after expiry (skipped - Bankrun clock limitation)
- [~] `ping` - Delegate can ping (skipped - Bankrun wallet funding limitation)

### P1 Core Functionality (5/5) ‚úÖ
- [x] `initializeVault` - Should reject name too long
- [x] `setDelegate` - Owner sets delegate successfully
- [x] `updateVault` - Owner updates vault name
- [x] `initializeVault` - Should reject zero time_interval
- [x] `updateVault` - Non-owner cannot update

### P2 Edge Cases (7/9)
- [x] `topUpBounty` - Owner adds to bounty
- [x] `closeVault` - Owner closes unreleased vault
- [x] `initializeVault` - Duplicate seed fails
- [x] `initializeVault` - Minimum values (time=1, bounty=0)
- [x] `ping` - Multiple pings in sequence
- [x] `setDelegate` - Clear delegate
- [x] `topUpBounty` - Zero top-up (error case)
- [ ] `initializeVault` - IPFS CID too long
- [ ] `closeVault` - Cannot close released vault

### Happy Path (2/2) ‚úÖ
- [x] `initializeVault` - Basic initialization
- [x] `ping` - Check-in updates timestamp

### SPL Token Tests (0/9) - P4 Priority
- [ ] `lockTokens` - Lock SPL tokens successfully
- [ ] `lockTokens` - Cannot lock twice
- [ ] `lockTokens` - Invalid mint address
- [ ] `claimTokens` - Recipient claims after release
- [ ] `claimTokens` - Cannot claim before release
- [ ] `claimTokens` - Cannot claim with no tokens
- [ ] `claimAndClose` - Atomic claim and close
- [ ] `claimAndClose` - Cannot claim unreleased
- [ ] Full release flow with time expiry

---

## üî¥ Remaining Test Cases (13 tests)

### P0 Security (2 tests) - SKIPPED

#### `triggerRelease` - Release after expiry ‚è∞
```typescript
it("triggerRelease - Should succeed after expiry", async () => {
    // 1. Initialize vault with 10s interval
    // 2. Warp time forward 15s using context.setClock()
    // 3. Call triggerRelease
    // 4. Verify vault.is_released == true
    // 5. Verify hunter receives bounty
});
```
**Complexity**: Medium (requires Bankrun time manipulation)

#### `ping` - Delegate authorization
```typescript
it("ping - Delegate can ping vault", async () => {
    // 1. Initialize vault
    // 2. Set delegate wallet
    // 3. Ping as delegate (not owner)
    // 4. Verify lastCheckIn updated
});
```
**Complexity**: Low

---

### P1 Core Functionality (2 tests)

#### `initializeVault` - Invalid time_interval
```typescript
it("initializeVault - Should reject zero time_interval", async () => {
    // Use time_interval = 0 or negative
    // Expect error code: InvalidTimeInterval
});
```

#### `updateVault` - Unauthorized update
```typescript
it("updateVault - Non-owner cannot update", async () => {
    // Random wallet tries updateVault
    // Expect constraint violation
});
```

---

### P2 Edge Cases (7 tests)

#### Input Validation
```typescript
it("initializeVault - Should reject duplicate seed", async () => {
    // Initialize vault with seed=12345
    // Try to initialize again with same seed
    // Expect account already exists error
});

it("initializeVault - Should reject IPFS CID too long", async () => {
    // Use CID > MAX_IPFS_CID_LEN (typically 64-128 chars)
    // Expect IpfsCidTooLong error
});

it("initializeVault - Minimum values accepted", async () => {
    // time_interval = 1, bounty = 0, locked = 0
    // Should succeed with edge case values
});
```

#### Vault Lifecycle
```typescript
it("ping - Multiple pings update timestamp", async () => {
    // Ping 3 times in sequence
    // Verify lastCheckIn updates each time
    // (May need small delays or mock time)
});

it("closeVault - Cannot close released vault", async () => {
    // Trigger release, then try closeVault
    // Expect error (must use claimAndClose)
});
```

#### Delegation
```typescript
it("setDelegate - Clear delegate to None", async () => {
    // Set delegate, then clear it
    // Verify vault.delegate == None
});
```

#### Bounty
```typescript
it("topUpBounty - Zero top-up", async () => {
    // Call topUpBounty(0)
    // Expect no-op or error
});
```

---

### SPL Token Tests (T.2 Feature) - 9 tests

#### `lockTokens` (3 tests)
```typescript
it("lockTokens - Lock SPL tokens successfully", async () => {
    // 1. Mint test SPL token
    // 2. Initialize vault
    // 3. Create token accounts (owner, vault)
    // 4. Lock tokens
    // 5. Verify vault.token_mint, vault.locked_tokens
});

it("lockTokens - Cannot lock twice", async () => {
    // Lock tokens, then try again
    // Expect error if not additive
});

it("lockTokens - Invalid mint address", async () => {
    // Use wrong mint
    // Expect constraint violation
});
```

#### `claimTokens` (3 tests)
```typescript
it("claimTokens - Recipient claims after release", async () => {
    // 1. Lock tokens
    // 2. Trigger release
    // 3. Recipient claims
    // 4. Verify token transfer
});

it("claimTokens - Cannot claim before release", async () => {
    // Lock tokens, try claim immediately
    // Expect VaultNotReleased
});

it("claimTokens - Cannot claim with no tokens", async () => {
    // Vault with locked_tokens = 0
    // Expect error or no-op
});
```

#### `claimAndClose` (2 tests)
```typescript
it("claimAndClose - Atomic claim and close", async () => {
    // 1. Initialize + lock SOL + tokens
    // 2. Trigger release
    // 3. claimAndClose as recipient
    // 4. Verify funds + tokens transferred
    // 5. Verify account closed
});

it("claimAndClose - Cannot claim unreleased", async () => {
    // Try claimAndClose before release
    // Expect VaultNotReleased
});
```

#### Time-based Release Flow (1 test)
```typescript
it("Full release flow with time expiry", async () => {
    // 1. Initialize (10s interval)
    // 2. Warp time +15s
    // 3. Hunter triggers release
    // 4. Verify bounty paid to hunter
    // 5. Recipient claims SOL + tokens
    // 6. Verify all transfers
});
```

---

## üõ†Ô∏è Implementation Guide

### Phase 1: Complete P0 (2 tests) - **DO NEXT**
**Est**: 30 mins  
**Files**: `tests/bankrun/vault.test.ts`

1. Research `solana-bankrun` time manipulation API
2. Implement `triggerRelease` after expiry test
3. Implement delegate ping test

### Phase 2: Add P1 (2 tests)
**Est**: 15 mins  
**Files**: `tests/bankrun/vault-p1.test.ts`

Simple error case tests, no complexity.

### Phase 3: Complete P2 (7 tests)
**Est**: 45 mins  
**Files**: `tests/bankrun/vault-p2.test.ts`

Edge cases and lifecycle tests.

### Phase 4: SPL Token Tests (9 tests) - **OPTIONAL for hackathon**
**Est**: 2-3 hours  
**Files**: `tests/bankrun/vault-spl.test.ts`

Requires:
- SPL Token minting in Bankrun
- Token account creation
- Transfer verification

---

## üìê Testing Principles

### 1. Isolation
Each test uses unique vault seed to avoid cross-contamination:
```typescript
const vaultSeed = new BN(100001 + testIndex);
```

### 2. AAA Pattern
- **Arrange**: Setup vault, accounts
- **Act**: Call instruction
- **Assert**: Verify state changes

### 3. Error Matching
```typescript
try {
    await program.methods.triggerRelease()...
    expect.fail("Should have thrown");
} catch (err: any) {
    expect(err.error.errorCode.code).to.equal("NotExpired");
}
```

### 4. Time Manipulation
```typescript
const currentClock = await context.banksClient.getClock();
context.setClock({
    ...currentClock,
    unixTimestamp: currentClock.unixTimestamp + BigInt(15)
});
```

---

## ‚úÖ Verification

Run all tests:
```bash
cd deadmans-switch
yarn test:fast
```

**Expected**:
- Current: `10 passing (~1s)`
- After Phase 1: `12 passing (~1.2s)`
- After Phase 2: `14 passing (~1.4s)`
- Complete (30 tests): `30 passing (~3s)`

---

## üìù Notes

### Why Bankrun?
1. **Speed**: 10-100x faster than local validator
2. **Isolation**: No state pollution between tests
3. **Time travel**: Easy clock manipulation for expiry tests
4. **Deterministic**: Same results every run

### Hackathon Priority
**Minimum viable**: 14 tests (P0 + P1 complete) = 47% coverage  
**Recommended**: 21 tests (P0 + P1 + P2) = 70% coverage  
**Full coverage**: 30 tests = 100%

### Next Steps
1. Complete P0 tests (critical security paths)
2. Document in `walkthrough.md`
3. Demo fast feedback loop in video (<2s test run)
