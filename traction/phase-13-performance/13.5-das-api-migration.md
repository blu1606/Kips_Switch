# ‚ö° Phase 13.5: DAS API Migration (Helius)

> **Status:** üìù Proposed
> **Priority:** Medium (Critical for Production)
> **Goal:** Replace heavy `getProgramAccounts` calls with high-performance Helius DAS API (Digital Asset Standard) for vault indexing.

## 1. üéØ The Problem

Currently, `src/app/api/actions/ping/route.ts` uses `connection.getProgramAccounts` (gPA) to find vaults owned by a user.

### Why gPA is bad for production:
1.  **Heavy Load:** It scans the entire account set of the program, which is CPU/Memory intensive for RPC nodes.
2.  **Rate Limits:** Most public/shared RPCs (including Helius free tier) heavily throttle or ban gPA calls.
3.  **Latency:** Response times increase linearly with the number of vaults.

## 2. üìê The Solution: Helius DAS API

Use the **Helius Digital Asset Standard (DAS) API** or **Photon Indexer** to query accounts instantly.

### Why DAS?
- **Indexed:** Data is pre-indexed, allowing sub-100ms lookups.
- **Scalable:** Handles millions of accounts without performance degradation.
- **Rich Data:** Can return parsed data if configured correctly.

## 3. üõ†Ô∏è Implementation Strategy

### Step 1: Helius Setup
1.  Get a Helius API Key.
2.  Add to `.env`: `HELIUS_API_KEY=...`

### Step 2: Replace Logic in `route.ts`

**Current (Old):**
```typescript
const accounts = await connection.getProgramAccounts(PROGRAM_ID, {
    filters: [
        { memcmp: { offset: 0, bytes: VAULT_DISCRIMINATOR } },
        { memcmp: { offset: 8, bytes: owner.toBase58() } }
    ]
});
```

**New (DAS):**
```typescript
const response = await fetch(`https://mainnet.helius-rpc.com/?api-key=${process.env.HELIUS_API_KEY}`, {
    method: 'POST',
    body: JSON.stringify({
        jsonrpc: '2.0',
        id: 'my-id',
        method: 'getProgramAccounts', // Helius optimized gPA or use getAssetsByOwner if we convert vaults to assets
        params: {
            programId: PROGRAM_ID.toBase58(),
             // ...
        }
    })
});
// OR preferably use their specific indexer endpoints if we index our program
```

*Alternative (Geyser Plugin):*
If the standard DAS API doesn't support raw program account filtering easily, we can use **Helius Webhooks** to listen for `VaultCreated` events and index them into our own Supabase database.

### Step 3: Supabase Indexing (Recommended)

Since we already use Supabase, the best "Production" approach is:
1.  **Listen:** Set up a Helius Webhook for `Vault` program logs.
2.  **Index:** specific `Vault` accounts into a `vaults` table in Supabase.
    -   `pubkey` (PK)
    -   `owner`
    -   `is_released`
    -   `last_check_in`
3.  **Query:** `route.ts` simply queries Supabase: `supabase.from('vaults').select('*').eq('owner', owner)`.

## 4. ‚úÖ Verification

- [ ] Measure latency of `/api/actions/ping` (Target: < 500ms).
- [ ] Verify 100% accuracy of vault retrieval.
