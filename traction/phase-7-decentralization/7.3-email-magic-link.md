# 7.3 Email Magic Link (Snooze)

> "Check-in without connecting your wallet."

## ğŸ¯ Goal
Allow users to reset their vault timer by clicking a link in the reminder email.

## ğŸ“ How It Works

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Email      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cron/     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚    User     â”‚
â”‚  Reminder   â”‚  "Click to    â”‚   (Email)   â”‚
â”‚   System    â”‚   check in"   â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ Click magic link
                                     â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  /api/      â”‚
                              â”‚  magic-ping â”‚
                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ Validate JWT
                                     â”‚ Platform wallet signs
                                     â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  Solana     â”‚
                              â”‚  ping()     â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ Prerequisites

1. **Platform Wallet** - Backend keypair that acts as delegate
2. **User Opt-in** - User must set platform as delegate first
3. **JWT Token** - Secure, time-limited token in email link

## ğŸ“ API Spec

### `/api/magic-ping`
```typescript
// GET /api/magic-ping?token=xxx&vault=xxx

export async function GET(req: Request) {
  const { searchParams } = new URL(req.url);
  const token = searchParams.get('token');
  const vaultPubkey = searchParams.get('vault');
  
  // 1. Validate JWT
  const payload = verifyJWT(token);
  if (!payload || payload.vault !== vaultPubkey) {
    return Response.json({ error: 'Invalid token' }, { status: 401 });
  }
  
  // 2. Check vault has platform as delegate
  const vault = await getVault(vaultPubkey);
  if (vault.delegate !== PLATFORM_PUBKEY) {
    return Response.json({ error: 'Not enrolled' }, { status: 403 });
  }
  
  // 3. Call ping() using platform keypair
  const tx = await callPingAsDelegate(vaultPubkey);
  
  // 4. Redirect to success page
  return Response.redirect(`${APP_URL}/check-in-success`);
}
```

### Email Template
```html
<p>Your vault "Secret Keys" needs attention.</p>
<p>Time remaining: 5 days</p>

<a href="https://app.com/api/magic-ping?token=xxx&vault=xxx">
  âœ… Click here to check in (no wallet needed)
</a>

<p>Or log in to check in manually.</p>
```

## ğŸ’° Cost
- Platform pays tx fee: ~0.000005 SOL per ping
- 1000 pings/month = ~$0.01/month
- Negligible

## âœ… Execution Steps

- [ ] Create platform keypair (store in env)
- [ ] Add `/api/magic-ping` endpoint
- [ ] Generate JWT tokens in reminder emails
- [ ] Create "Enroll in Magic Link" toggle in Settings
- [ ] Auto-set platform as delegate when enrolling
